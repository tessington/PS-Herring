---
title: "Puget Sound Herring Analysis Summary"
author: "Tim Essington and Leah Davis"
date: "6/7/2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/PS-HERRING-FUNS.R")
```

# Introduction

Contemporary conservation efforts commonly utilize a trade-off-based approach called ecosystem-based management (EBM) to allocate limited funds towards the most vulnerable regions which provide the highest ecosystem benefits (economic, cultural, recreational, aesthetic, etc.) for humans. EBM plans assess the relationships between human activities and desired ecosystem structures and functions to create marine use policies. This, called the ecological production function approach, enables the prediction of ecosystem outcomes under different marine use schemes economic, cultural, recreational, aesthetic, etc.) for humans (Tallis et al. 2010, Guerry et al. 2012, Halpern et al. 2013). In practice, this often entails identifying benefits, the ecological processes that provide them, and their primary threats (Levin et al. 2009).

EBM is thus most effective when impacts of one or more distinct stressor on desired ecosystem structures can be identified, quantified, and reduced. However, this process is more difficult when the threats are numerous or not easily identifiable, or when there are important interactions between multiple threats on the system (Ban et al. 2010, Hodgson et al. 2019). 

Within the Puget Sound, many ecosystems largely benefit human well-being and their severe degradation warrants conservation action (Puget Sound Partnership 2010). While much attention has been paid to culturally significant species such as Killer Whales (genus spc) and chinook salmon (genus spc), decreases in critical prey species such as Pacific Herring (Clupea pallasii) over the past several decades have been decreasing but have not been a focus. (Greene et al. 2015, Siple et al. 2017).

Pacific Herring are a forage fish species which play important ecological roles as a zooplankton predator and as a prey species to marine mammals, salmonids, and seabirds (Duffy et al., 2010; Lance and Thompson, 2005; Lance and Jeffries, 2006). Therefore, their presence directly impacts numerous ecosystem benefits, making the need for healthy populations greater. These continued declines pose a threat to the recovery efforts for Chinook salmon (Duffy et al., 2011) and, by extension, impacts endangered marine mammals which preferentially feed on Chinook such as Southern Resident Orcas (Ford and Ellis, 2006). 

There are many potential drivers underlying the decline in Pacific herring in Puget Sound (The Salish Sea Pacific Herring Assessment and Management Strategy Team 2018).  Mortality rates are likely elevated due to disease outbreaks (Hershberger et al. 2002), exposure to organic pollutants (West et al. 2008) and predation by a large and growing pinniped population (Essington et al. 2021).  At the same time, nearshore spawning and juvenile nursery habitats may be degraded by shoreline armoring (Dethier et al. 2017). Given the rapidly increasing human population around Puget Sound, this, and other landscape-level effects of this growth in the watershed are likely to continue or increase into the future. Despite this, we currently have limited understanding about the relative magnitudes of these threats, how they interact, and which are most responsible for the decline in Pacific herring.

Pacific herring spawn in the same nearshore locations at the same times from year to year (Chapman et. al., 1941). These differences in spawning behavior create distinct subpopulations of Pacific herring, referred to as “sub-stocks” in this study. In the Puget Sound region, there are 22 distinct sub-stocks (Siple & Francis, 2016). These stocks, from Cherry Point and Case Inlet, are genetically distinct from the coastal rest of the Pacific herring (Gustafson, 2005). They are considered moderately healthy but are experiencing a decline in their spawning biomass (Siple and Francis, 2016).

There is substantial spatial variation in the dynamics of sub-stocks, with each spawning region varying widely in natural and anthropogenic land cover and use. This leads to differing levels of disturbances in their respective nearshore environments. The State of Washington has been monitoring and assessing spawning biomass in these regions for up to 50 years (Stick et al. 2014). The resulting spatial mosaic of population trends and accompanying land use provides an opportunity to identify some of the landscape features associated with local trends in spawning. 

For the first time, we synthetically evaluate sub-stocks to determine whether there are associations between status and trends and local land use characteristics in this study. Status and trends were summarized using multiple metrics, making them more founded than previous studies which relied on fewer metrics. We also evaluated whether sub-stock status is associated with current land use properties and changes in land use properties over the past two decades, which has not been previously studied in the Puget Sound region. 

We expect that most sub-stocks will have declining trends over the two-decade study period. We hypothesize that if herring population changes are a result of one of our tested stressors, then there will be a connection between that stressor and biomass declines. In turn, if there are compounding interactions between the disturbances or the declines are a result of a stressor not included in this study, then we will see no connection between declines and any one of these tested stressors. 

Overall, this study is intended to be the first attempt to identify potential causal linkages at the local scale, which if present, would inform land use policies and restoration priorities. 


# Methods step one: estimate slopes using regression and other models.

## Methods Overview
Our approach was to first characterize herring status and trends at the subpopulation level using a variety of metrics, and identifying those that provided unique information.  We then calculated watershed land cover types and proportions for each spawning location based on adjoining watersheds.  Finally, we asked whether the status and trends metrics were correlated with current land use, or with changes in land use from mid 1990s to present.


## Indicator Variables
We choose to use a range of metrics of population status and trends.  The first four were:

* log - ratio of first to final year biomass: 

$\log(B_{ymin} +1) - \log(B_{tmax} +1)$

* log -ratio of maximum biomass to mean biomass since 2010:

$\log(\underset{t} \max(B_t) +1) - \log( \underset{t \geq 2010}{\overline{B_t}} +1)$

* number of years after year 2000 with 0 biomass: 

$\sum_{t = 2000} ^ {t_{max}} \begin{cases} 1 \text{ if } B_t = 0 \\ 0 \text{ otherwise} \end{cases}$

* did the lowest observed biomass occur after 2010?

To these simple metrics, we added two additional metrics.  The firs was the output of a regression of biomass vs. year, using date from 1995 onward (or first available year if later than 1995). We used the t-statistic of the estimated slope as a measure of signal-to-noise (and direction of trend).  

Using a t-statistic as a measure of signal-to-noise has some downsides - stocks with inherently lower inter-annual variabilty around the trend line will have larger magnitude t-statistic than one with more variability, even if the rate of change is the same. Also, it may not necessarily account for the scaling of population sizes (e.g. will larger populations have larger magnitude t-statistics).

For that reason, we explored an alternative model so that the estimated trend parameter was independent of the overall population size. This model admits that there is variability in two places - the underlying population dynamics, and in the observations in each year.  It does this by modeling / estimating the "true" state of the stocklet in each year, and relating that to the observed density.

The true population density in each year is:

$$ B_t = B_o e^{\beta_t + \epsilon_t}$$

$$\epsilon_t \sim N(0, \sigma^2) $$

$\beta$ is the exponential growth rate (which can be positive or negative) having units of yr^-1, and $\epsilon_t$ is a normally distributed random variable with mean 0 and standard deviation equal to $\sigma$.  In plain language, this says that there is an overall trend described by $\beta$, but that in each year the stocklet state might differ from that expected by the trend due to random processes.

 The observed numbers in each year were presumed to be tweedie-distributed random variables:

$$B_{t,observed} \sim \text{Tweedie}(B_{t}, \phi, p)$$

where $phi$ and $p$ are estimated parameters.  When $p$ is constrained to lay between 1 and 2, we get something very useful in that the probability is defined for $B_t$ =0, and also for all real positive numbers.  

Parameter estimation was conducted using Template Model Builder to integrate over the random effects, $N_{t,true}$ and to estimate the fixed effects.


<!-- ## Example R Code -->

<!-- Below is the code I used to first run the simple linear regression and extract the slope, standard error, and t-statistic.  I fit the more complicated model using code that is too messy to show here, but saved it as an ".RDS" file. -->
```{r loadpackages, echo= F,  message = F}

library(reshape2)
library(ggplot2)
library(dplyr)
library(tweedie)
library(readxl)
library(vegan)
library(ape)
library(gridExtra)
library(viridis)

```

```{r run_regression,echo = F, message = F}
defaultW <- getOption("warn") 
options(warn = -1) 


earliest.year <- 1995

wdfw.data.raw <- read.csv(file = "data/wdfw-data.csv", header = T)
wdfw.data <- reshape2::melt(wdfw.data.raw, id = "YEAR", variable.name = "stocklet", value.name = "biomass")
wdfw.data$basin <- rep(NA, times = nrow(wdfw.data))

## assign basins                     
south <- c("SQUAXIN", "PURDY", "WOLLOCHET", "QM")
central <- c("ELLIOTT", "PO.PM")
hoodcanal <- c("SOUTH_HC", "QUILCENE", "PTGAMBLE")
sanjuandefuca <- c("KILISUT", "DISCOVERY", "SEQUIM", "DUNGENESS")
whidbey <- c("PTSUSAN", "HOLMES", "SKAGIT")
north <- c("FIDALGO", "SAMISH_PORTAGE", "SEMIAHMOO", "CHERRYPT", "NWSJI", "INT.SJI")

south.index <- which(wdfw.data$stocklet %in% south)
central.index <- which(wdfw.data$stocklet %in% central) 
hoodcanal.index <- which(wdfw.data$stocklet %in% hoodcanal)
sanjuandefuca.index <- which(wdfw.data$stocklet %in% sanjuandefuca)
whidbey.index <- which(wdfw.data$stocklet %in% whidbey)
north.index <- which(wdfw.data$stocklet %in% north)
wdfw.data$basin[south.index] <- "south"
wdfw.data$basin[central.index] <- "central"
wdfw.data$basin[hoodcanal.index] <- "hoodcanal"
wdfw.data$basin[sanjuandefuca.index] <- "sanjaundefuca"
wdfw.data$basin[whidbey.index] <- "whidbey"
wdfw.data$basin[north.index] <- "north"

wdfw.data$basin <- as.factor(wdfw.data$basin)

# configure regression analysis
stocklet.names <- c(south, central, hoodcanal, sanjuandefuca, whidbey, north)
# dataframe to hold output
regression.output <- data.frame(stocklet = stocklet.names,
                                slope = NA,
                                se = NA,
                                tval = NA,
                                beta = NA,
                                beta_se = NA)

# Import the estimated effect sizes and the standard errors
n.stocks <- length(stocklet.names)
# loop through each stock, each time fitting a linear model, save the fitted slope, standard error, p value, and t-statistic in dataframe
for (i in 1:n.stocks) {
stocklet.2.use <- stocklet.names[i]
dat <- dplyr::filter(wdfw.data, stocklet == stocklet.2.use, YEAR>=earliest.year)
# remove NA's from dat
dat <- dat[complete.cases(dat),]
dat$YEAR <- dat$YEAR - 1995 # subtract 1995 from each year so that t for 1995 =0, t for 1996 = 1, etc.

lm.output <- lm(biomass ~ YEAR, data = dat)
se <- sqrt(diag(vcov(lm.output)))
regression.output[i,2] <- lm.output$coefficients[2]
regression.output[i,3] <- se[2]
regression.output[i,4] <- summary(lm.output)$coefficients[2,3]
}
# import the fits from the fancier model
state.space.output <- readRDS("R/state_space_output.RDS")

# merge the two
regression.output$beta <- state.space.output$beta
regression.output$beta_se <- state.space.output$beta_se
# print the output
print(regression.output[, -c(2,3)])


```
## Correlation among response metrics

The next step was to see how much "new" information each metric was providing.  An easy way to do that is simply to calculate the correlation between all pairs of response variables (removing the binary response to whether lowest observed biomass occured in recent time period).

```{r correlationtest, echo = F}
# calculate response variables (replacing data tables in excel spreadsheet HerringProjectR)



# set up dataframe for holding response variables
thedata <- data.frame(stocklet = stocklet.names,
                      ave_to_highest = NA,
                      first_to_last = NA,
                      freq_zeros = NA,
                      lb = NA)


# now add to "thedata" the t statistic of the linear regression, and the new unitless slope
thedata <- inner_join(thedata, regression.output)


# little function to calculate first to last and average to highest observed

get_ratios <- function(x) {
  x <- x[which(!is.na(x))] # remove NAs
  nx <- length(x)
  first_to_last <- log(x[1] +1) - log(x[nx]+1) # adding 1 to deal with zeros
  ave_to_highest <- log(max(x) +1) -  mean(x[(nx-10):nx]+1) # mean over the last ten years of data, adding 1
  return(list(first_to_last = first_to_last, ave_to_highest = ave_to_highest))
}

calc_lb <- function(data_ts) {
  # first get the first year of data
  years <- data_ts$YEAR[which(!is.na(data_ts$biomass))]
  if (min(years) >= 2000) {
    lb.val = "no"
  } else {
      min.b <- min(data_ts$biomass, na.rm = T)
      min.b.recent <- min(data_ts$biomass[data_ts$YEAR >2010], na.rm = T)
      lb.val <- ifelse(min.b == min.b.recent, "yes", "no")
  }
  return(lb.val)
}

calc_zeros <- function(data_ts) {
  # get data past 1995
  data_ts <- dplyr::filter(data_ts, YEAR >= 1995)
  n.years <- length(which(!is.na(data_ts$biomass))) # how many years of data
  n.zeros <- length(which(data_ts$biomass ==0)) # how many years had 0 spawning biomass
  return(n.zeros / n.years)
  
  
}
      

# loop through thedata, update metrics
for (i in 1:n.stocks) {
  stocklet.2.use <- thedata$stocklet[i]
  data.2.use <- dplyr::filter(wdfw.data, stocklet == stocklet.2.use)
  ratios <- get_ratios(data.2.use$biomass)
  thedata$ave_to_highest[i] <- ratios$ave_to_highest
  thedata$first_to_last[i] <- ratios$first_to_last
  thedata$lb[i] <- calc_lb(data.2.use)
  thedata$freq_zeros[i] <- calc_zeros(data.2.use)
  
}

response_vars <- dplyr::select(thedata,
                        tval, freq_zeros, ave_to_highest, first_to_last, beta)

# log the ratio indicators
# calculate and print out the response variables, omiting those that have NA's
print(cor(response_vars, use = "complete.obs"))
```

The $\beta$ parameter from the state-space model is very highly correlated with nearly all of the other indicators (the only one that it doesn't capture is the ratio of first observed biomass to last observed biomass).  Thus, we can use  $\beta$ as our primary index of sub-stock trend, without worrying about the others.


```{r plotresponse, echo =FALSE}

col <- viridis(n = 10, option= "mako") [7]
thedata$lb <- as.factor(thedata$lb)
tvalplot <- ggplot(thedata, aes(x = tval)) +
  geom_histogram(position = "identity", alpha = 1.0, bins = 10,
                 color = "black", fill = col) +
  theme_bw() + 
  labs(x = "Regression Slope", y = "Count") + 
  theme(panel.grid.major = element_blank()
        ,panel.grid.minor = element_blank()
        ,panel.border = element_blank()
  ) +
  theme(axis.line = element_line(color = "black")) +
  theme(axis.text = element_text(size = 12)) +
  theme(axis.title= element_text(size = 14)) +
  theme(strip.text = element_text(size = 14)) +
  theme(legend.text = element_text(size = 12)) + 
  theme(strip.background = element_blank()) + 
  theme(axis.line=element_line())
  
zerosplot <- ggplot(thedata, aes(x = freq_zeros)) +
  geom_histogram(position = "identity", alpha = 1.0, bins = 10,
                 color = "black", fill = col) + 
  theme_bw() + 
  labs(x = "Frequency of 0's", y = "Count") + 
  theme(panel.grid.major = element_blank()
        ,panel.grid.minor = element_blank()
        ,panel.border = element_blank()
  ) +
  theme(axis.line = element_line(color = "black")) +
  theme(axis.text = element_text(size = 12)) +
  theme(axis.title= element_text(size = 14)) +
  theme(strip.text = element_text(size = 14)) +
  theme(legend.text = element_text(size = 12)) + 
  theme(strip.background = element_blank()) + 
  theme(axis.line=element_line())
ave_highestplot <- ggplot(thedata, aes(x = ave_to_highest)) +
  geom_histogram(position = "identity", alpha = 1.0, bins = 10, color = "black", fill = col) + 
  theme_bw() + 
  labs(x = "log(mean / maximum )", y = "Count") + 
  theme(panel.grid.major = element_blank()
        ,panel.grid.minor = element_blank()
        ,panel.border = element_blank()
  ) +
  theme(axis.line = element_line(color = "black")) +
  theme(axis.text = element_text(size = 12)) +
  theme(axis.title= element_text(size = 14)) +
  theme(strip.text = element_text(size = 14)) +
  theme(legend.text = element_text(size = 12)) + 
  theme(strip.background = element_blank()) + 
  theme(axis.line=element_line())
first_lastplot <- ggplot(thedata, aes(x = first_to_last)) +
  geom_histogram(position = "identity", alpha = 1.0, bins = 10, color = "black", fill = col) + 
  theme_bw() + 
  labs(x = "log(initial / final) ", y = "Count") + 
  theme(panel.grid.major = element_blank()
        ,panel.grid.minor = element_blank()
        ,panel.border = element_blank()
  ) +
  theme(axis.line = element_line(color = "black")) +
  theme(axis.text = element_text(size = 12)) +
  theme(axis.title= element_text(size = 14)) +
  theme(strip.text = element_text(size = 14)) +
  theme(legend.text = element_text(size = 12)) + 
  theme(strip.background = element_blank()) + 
  theme(axis.line=element_line())
betaplot <- ggplot(thedata, aes(x = beta)) +
  geom_histogram(position = "identity", alpha = 1.0, bins = 10, color = "black", fill = col) + 
  theme_bw() + 
  labs(x = "Population Growth Rate", y = "Count") + 
  theme(panel.grid.major = element_blank()
        ,panel.grid.minor = element_blank()
        ,panel.border = element_blank()
  ) +
  theme(axis.line = element_line(color = "black")) +
  theme(axis.text = element_text(size = 12)) +
  theme(axis.title= element_text(size = 14)) +
  theme(strip.text = element_text(size = 14)) +
  theme(legend.text = element_text(size = 12)) + 
  theme(strip.background = element_blank()) + 
  theme(axis.line=element_line())
lowestplot <- ggplot(thedata, aes(lb)) +
  geom_bar(colour = "black", fill = col) + 
  theme_bw() + 
  labs(x = "Lowest Biomass?", y = "Count") + 
  theme(panel.grid.major = element_blank()
        ,panel.grid.minor = element_blank()
        ,panel.border = element_blank()
  ) +
  theme(axis.line = element_line(color = "black")) +
  theme(axis.text = element_text(size = 12)) +
  theme(axis.title= element_text(size = 14)) +
  theme(strip.text = element_text(size = 14)) +
  theme(legend.text = element_text(size = 12)) + 
  theme(strip.background = element_blank()) + 
  theme(axis.line=element_line())
grid.arrange(tvalplot, zerosplot, ave_highestplot, first_lastplot, betaplot, lowestplot, nrow = 2) 
  

```
## Overall summary of response metrics
In general, all of the response metrics point to declining substock status over time.  The only metric that suggested mixed status was the ratio of initial to final population biomass, but this likely suggests that the metric itself is not very sensitivite to larger population trends because it is less precise.  The population growth rates of substocks were generally negative, with only four stocks having positive maximum likelihood estimates of $\beta$, and only none of these were significantly distinguishable from 0.  In comparison, 7 stocks had population declines that were statistically distinguishable from 0.

# Landscape level predictor variables

We identified all HUC-12 watersheds that were directly proximate to known spawning areas for each substock.  For each, we calculated the percentage ground cover for each of 8 main landcover types: forest, agriculture, estuarine, palustrine, bare land, grassland, scrub / shrub, and developed.  We also used calculated total of human population size in associated with watersheds adjacent to substock spawning sites, and the percent of impervous surfaces.


```{r landcover, echo = F, include = F, message = F} 

# load the RDS file generated by the R source code "landuse_by_stocklet"
source(file = "R/landuse_by_stocklet.R")
source(file = "R/human_by_stocklet.R")
source(file = "R/Impervious_by_stocklet.R")
```



We used land cover in two ways.  The first asked whether the substock status trends can be predicted by the 2016 land use to capture coarse differences in land use among substocks  We reduce the dimensionality of land cover via ordination using  using Principal Coordinate Analysis (PCoA).  We therefore transfored the raw cover proportions using an arcsine square root transformation.  This was used instead of a logit  / probit transform because 0's are not defined in this transformation but are common in the data.  We then calculated the first two axes of the PCoA using a Bray-Curtis dissimilarity matrix of the transformed land cover and using the cmdscale function in the stat base package.  

The second asked whether substock status trends can be predicted by the change in land cover between 1996 and 2016. Here, the ordination was done by first calculating the change in each land cover proportion, and then calculating a Principal Components Analysis on the euclidian distance matrix of land cover changes. This was done because change in land cover will produce both positive and negative values, the latter of which cannot be handled by PCoA.  

```{r ordination, echo = F}

red_lc_2016_tf <- asinTransform(red_stocklet_lc_2016[,-1])
red_lc_1996_tf <- asinTransform(red_stocklet_lc_1996[,-1])
red_change_tf <- red_lc_2016_tf - red_lc_1996_tf

# remove snow/ ice from change because there is little or no change there

red_change_tf <- red_change_tf %>%
  select(-Snow_Ice, -Water, -NoDATA)

distance <- vegdist(red_lc_2016_tf, method = "bray")
PCOA <- pcoa(distance)
biplot(PCOA, red_change_tf)

ord_predictor_2016 <- stats::cmdscale(distance, k = 2, eig = T)
x <- ord_predictor_2016$points[,1]
y <- ord_predictor_2016$points[,2]




# repeat for change in land cover. Note here, distance measure is the euclidian distance of the correlation matrix of transformed proportional change, and we use PCA on this

ord_predictor_change <- princomp(x = red_change_tf, scores = T, cor = T)

x_change <- ord_predictor_change$scores[,1]
y_change <- ord_predictor_change$scores[,2]


par(mfrow = c(1,1))

biplot(ord_predictor_change, main = "ordination on land cover change")
```


We then used the PCoA and PCA coordinates as predictors of our response metrics.  We only used $\beta$ and the bivariate response metrix "lowest biomass" are as response metrics because of the high correlation among the other metrics.  We fit multiple models to each response metric, each of which contained distinct subset of predictor variables (2016 human density, land cover, and imperviousness, and change in human density, land cover, and imperviousness).  We evaluated the support for each model using small sample-size corrected AIC (AICc).  We used weighted regression to relate predictor variables to population growth rate, where weights were equal to the inverse of the standard error.

```{r use_ordination, echo = F}

# Run analyses on ordinated predictor variable
# create new, revised dataset that has coordinate 1 and coordinate 2 values together
# with the two uncorrelated response variables
# complicated code but it is just putting data all together

### Need to change long stocklet names to short stocklet names

longstocklet <- unique(stock.hucs$StockletID)

shortstocklet <- sapply(X = longstocklet, FUN = convertNames)

new.df <- inner_join(data.frame(stocklet = shortstocklet,
                     coord1 = x,
                     coord2 = y,
                     changecoord1 = x_change,
                     changecoord2 = y_change,
                     changecoord3 = ord_predictor_change$scores[,3],
                     changecoord4 = ord_predictor_change$scores[,4]),
                     dplyr::select(thedata,
                                   stocklet,
                                   lb,
                                   beta,
                                   beta_se))

# now add human density
human_by_stocklet <- rename(human_by_stocklet, stocklet = stockletID)
human_by_stocklet$stocklet <- sapply(X = human_by_stocklet$stocklet,
                                       FUN = convertNames)
new.df <- inner_join(new.df,
                     human_by_stocklet)

# add imperviousness
imp_by_stocklet <- rename(imp_by_stocklet, stocklet = stockletID)
imp_by_stocklet$stocklet <- sapply(X = imp_by_stocklet$stocklet,
                                       FUN = convertNames)

new.df <- inner_join(new.df,
                     imp_by_stocklet)

# try some simple linear models, use weighted regression for the betas

# convert Yes / No in "lowest_biomass" to 1 and 0
new.df$lb_num <- NA
new.df$lb <- as.character(new.df$lb) # remove factors from low biomass
new.df$lb_num[new.df$lb=="no"] <- 0
new.df$lb_num[new.df$lb=="yes"] <- 1
new.df$wt <- 1/new.df$beta_se

calc_aicc <-function(fit) {
  k <- length(fit$coefficients)
  n <- length(fit$fitted.values)
  AIC <- AIC(fit)
  return(AIC + 2* k * (k+1) / (n - k - 1))
}

# model selection on the probability that lowest biomass is in recent time period
AIClb <- rep(NA, times = 7)
fit.null <- glm(lb_num ~ 1 , family = binomial, data = new.df)
fit.lc <- glm(lb_num ~ ImpervPer, family = binomial, data = new.df)
fit.imp <- glm(lb_num ~ ImpervPer, family = binomial, data = new.df)
fit.human <- glm(lb_num ~ density, family = binomial, data = new.df)
fit.lc.change <- glm(lb_num ~  changecoord1 + changecoord2 + changecoord3, family = binomial, data = new.df)
fit.imp.change <- glm(lb_num ~ changeImperv, family = binomial, data = new.df)
fit.human.change <- glm(lb_num ~ change, family = binomial, data = new.df)


AIClb[1] <- calc_aicc(fit.null)
AIClb[2] <- calc_aicc(fit.lc)
AIClb[3] <- calc_aicc(fit.imp)
AIClb[4] <- calc_aicc(fit.human)
AIClb[5] <- calc_aicc(fit.lc.change)
AIClb[6] <- calc_aicc(fit.imp.change)
AIClb[7] <- calc_aicc(fit.human.change)

names(AIClb) <- c("null", "landcover", "impervious", "human density", "change landcover", "change impervious", "change human density")
DAIClb <- AIClb - min(AIClb)
print(DAIClb)

#summary(fit.human)
# model selection on estimated rate of population change

AICbeta <- rep(NA, times = 7)
names(AICbeta) <- c("null", "landcover", "impervious", "human density", "change landcover", "change impervious", "change human density")

fit.null <- glm(beta ~ 1, data = new.df, weights = wt)
fit.lc <- glm(beta ~ ImpervPer,  data = new.df, weights = wt)
fit.imp <- glm(beta~ ImpervPer, data = new.df, weights = wt)
fit.human <- glm(beta ~ density,  data = new.df, weights = wt)
fit.lc.change <- glm(beta ~  changecoord1 + changecoord2 + changecoord3,  data = new.df, weights = wt)
fit.imp.change <- glm(beta ~ changeImperv, data = new.df, weights = wt)
fit.human.change <- glm(beta ~ change,  data = new.df, weights = wt)

AICbeta[1] <- calc_aicc(fit.null)
AICbeta[2] <- calc_aicc(fit.lc)
AICbeta[3] <- calc_aicc(fit.imp)
AICbeta[4] <- calc_aicc(fit.human)
AICbeta[5] <- calc_aicc(fit.lc.change)
AICbeta[6] <- calc_aicc(fit.imp.change)
AICbeta[7] <- calc_aicc(fit.human.change)


DAICbeta <- AICbeta - min(AICbeta)
print(DAICbeta)
#summary(fit.human.change)
# make some plots
par(mfrow = c(1,2))
with(new.df, plot(density, lb_num,
                  pch = 21,
                  bg = "black",
                  xlab = "human density",
                  ylab = "is lowest biomass in recent period?",
                  las = 1)
)


with(new.df, plot(change, beta,
                  pch = 21,
                  bg = "black",
                  xlab = "rate of human popualtion change",
                  ylab = "rate of herring substock  change",
                  las = 1)
)

options(warn = defaultW)


```

# What does it all mean?

The two statistical models that had the most support for each metric resulted in an effect size that was opposite to what we had expected, and driven by a few outliers (especially human density and whether lowest biomass was in recent time period)

Generally, local watershed level features are not a good predictor of substock trends.  This is likely because substock dynamics were generally declining in all regions, indicating that system-wide influences are of primary importance.  For instance, diseases, predation mortality, larval survivorship, etc.

